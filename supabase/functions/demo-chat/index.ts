import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { message } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    
    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    if (!message) {
      throw new Error("Message is required");
    }

    console.log("Demo chat request received:", message);

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-3-flash-preview",
        messages: [
          {
            role: "system",
            content: `You are a friendly, helpful dental office assistant chatbot for Smile Dental Care. You help answer patient questions about dental care, appointments, and office info.

OFFICE INFO (use this in responses):
- Phone: (555) 555-5555
- Website: www.smiledentalcare.com
- Hours: Monday-Friday 8am-5pm, Saturday 9am-2pm
- Address: 123 Main Street, Suite 100

RULES:
- Be warm, professional, and thorough (4-6 sentences)
- Provide helpful information and context
- Always offer to help schedule an appointment or provide the phone number
- Never diagnose - encourage scheduling a visit for specific concerns
- Include relevant contact info when appropriate (phone or website)
- End responses with a helpful next step or question
- This is a DEMO - briefly mention the final version would be customized for their practice

Example response style:
"Great question! We typically recommend dental cleanings every 6 months to maintain optimal oral health and catch any potential issues early. Regular cleanings help prevent cavities, gum disease, and can even detect early signs of other health conditions. If it's been a while since your last visit, I'd be happy to help you schedule an appointment! You can also call us directly at (555) 555-5555 or book online at www.smiledentalcare.com. Is there anything else I can help you with?"`
          },
          { role: "user", content: message }
        ],
        stream: true,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      
      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "Rate limit exceeded. Please try again in a moment." }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "Service temporarily unavailable." }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      
      return new Response(JSON.stringify({ error: "Failed to get AI response" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    console.log("Streaming response back to client");
    
    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    console.error("Demo chat error:", error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : "Unknown error" }),
      {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  }
});
